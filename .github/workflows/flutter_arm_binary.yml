name: Build Full Flutter SDK for Termux (ARM64)

on:
  push:
    branches:
      - main

jobs:
  build-sdk:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repo (Flutter framework)
      - name: Checkout Flutter repository
        uses: actions/checkout@v4

      # 2️⃣ Install required tools
      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl unzip xz-utils tar zip

      # 3️⃣ Clone Flutter framework
      - name: Clone Flutter framework
        run: |
          git clone https://github.com/flutter/flutter.git flutter-sdk

      # 4️⃣ Download ARM64 Dart SDK (Termux compatible)
      - name: Download Dart SDK (ARM64)
        run: |
          mkdir -p flutter-sdk/bin/cache/dart-sdk
          curl -L https://storage.googleapis.com/dart-archive/channels/stable/release/3.10.7/sdk/dartsdk-linux-arm64-release.zip -o dart-sdk.zip
          unzip dart-sdk.zip -d flutter-sdk/bin/cache/dart-sdk
          rm dart-sdk.zip

      # 5️⃣ Remove minimal shim (use full Flutter bin)
      - name: Use full Flutter bin
        run: |
          # Full flutter/bin already exists from clone; nothing extra needed
          chmod +x flutter-sdk/bin/flutter

      # 6️⃣ Pre-cache Flutter artifacts
      - name: Pre-cache Flutter artifacts
        run: |
          cd flutter-sdk
          ./bin/flutter precache --arm64

      # 7️⃣ Verify pub commands (full Flutter)
      - name: Test pub and language-server
        run: |
          cd flutter-sdk
          ./bin/flutter pub get
          ./bin/flutter pub upgrade
          ./bin/flutter language-server --version || echo "LSP ready"

      # 8️⃣ Package & split SDK (100MB parts)
      - name: Package and split Flutter SDK for Termux
        run: |
          zip -r flutter-sdk-arm64.zip flutter-sdk
          split -b 100M flutter-sdk-arm64.zip flutter-sdk-arm64.zip.part-

      # 9️⃣ Upload split artifacts
      - name: Upload Flutter SDK artifact (split)
        uses: actions/upload-artifact@v4
        with:
          name: flutter-sdk-arm64
          path: flutter-sdk-arm64.zip.part-*
