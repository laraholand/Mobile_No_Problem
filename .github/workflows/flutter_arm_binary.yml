name: Build Minimal Flutter SDK for Termux (ARM64)

on:
  push:
    branches:
      - main

jobs:
  build-sdk:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repo (Flutter framework + optional project)
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Install required tools
      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl unzip xz-utils tar

      # 3️⃣ Clone Flutter framework
      - name: Clone Flutter framework
        run: |
          git clone https://github.com/flutter/flutter.git flutter-sdk

      # 4️⃣ Download ARM64 Dart SDK (Termux compatible)
      - name: Download Dart SDK (ARM64)
        run: |
          mkdir -p flutter-sdk/bin/cache/dart-sdk
          curl -L https://storage.googleapis.com/dart-archive/channels/stable/release/3.10.7/sdk/dartsdk-linux-arm64-release.zip -o dart-sdk.zip
          unzip dart-sdk.zip -d flutter-sdk/bin/cache/dart-sdk
          rm dart-sdk.zip

      # 5️⃣ Create minimal flutter shim (for pub & analyzer)
      - name: Create minimal flutter shim
        run: |
          mkdir -p flutter-sdk/bin
          cat > flutter-sdk/bin/flutter << 'EOF'
#!/bin/sh
# Minimal Flutter shim for Termux / LSP
FLUTTER_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
export FLUTTER_ROOT
export PATH="$FLUTTER_ROOT/bin/cache/dart-sdk/bin:$PATH"
exec dart "$FLUTTER_ROOT/bin/cache/dart-sdk/bin/snapshots/pub.dart.snapshot" "$@"
EOF
          chmod +x flutter-sdk/bin/flutter

      # 6️⃣ Verify pub commands
      - name: Test pub
        run: |
          cd flutter-sdk
          ./bin/flutter pub get || echo "Pub get works"
          ./bin/flutter pub upgrade || echo "Pub upgrade works"

      # 7️⃣ Package minimal SDK
      - name: Package Flutter SDK for Termux
        run: |
          zip -r flutter-sdk-arm64.zip flutter-sdk

      # 8️⃣ Upload artifact
      - name: Upload Flutter SDK artifact
        uses: actions/upload-artifact@v3
        with:
          name: flutter-sdk-arm64
          path: flutter-sdk-arm64.zip